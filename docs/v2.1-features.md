# Somnium v2.1.0 Features

**Release Date**: November 19, 2025
**Status**: In Development

## Overview

Version 2.1.0 introduces comprehensive content creation tools, enhanced AI systems, social features, and advanced asset management. This release completes the vision for Somnium as a full-featured adventure game creation platform.

---

## ğŸ¨ Visual Content Creation Tools

### World Editor (`editors/world-editor.html`)

Professional drag-and-drop world designer with real-time validation.

**Features:**
- **Interactive Canvas**: Zoom (25%-200%), pan, grid overlay
- **Drag-and-Drop**: Position rooms visually on canvas
- **Visual Connections**: Automatic connection rendering with directional arrows
- **Property Panels**:
  - Left: World properties, room list, template selector
  - Right: Room properties, exit management, objects/items
- **Auto-Layout**: Force-directed algorithm for optimal room placement
- **Validation Integration**: Real-time WorldValidator feedback
- **Save/Load**: Local Storage + JSON export
- **Statistics**: Live tracking of rooms, items, NPCs, puzzles

**Technical Details:**
- Canvas-based rendering with double buffering
- Grid snap (50px default, configurable)
- Minimap for navigation
- Keyboard shortcuts (Delete, Escape, Ctrl+S/O/N)
- ~1000 lines of JavaScript + HTML + CSS

**Usage:**
```bash
Open editors/world-editor.html in browser
Click "New" to start or "Load" to import existing world
Drag rooms to position, click to select, double-click to edit
Use "Add Room" to create new rooms
Configure exits in right panel
Click "Validate" to check world consistency
Save to localStorage or export to JSON file
```

---

### Puzzle Builder (`editors/puzzle-builder.html`)

Flowchart-style puzzle designer with dependency management and testing.

**Node Types:**
1. **Item Required** ğŸ”‘: Player must have specific item
2. **Action Required** âš¡: Player must perform action
3. **Sequence** ğŸ”¢: Steps must be completed in order
4. **Condition** â“: Check game state before proceeding
5. **Combine Items** ğŸ”—: Combine two items to create new item
6. **Trigger Event** ğŸ¯: Fire game event when completed

**Features:**
- **Visual Dependency Graph**: Auto-arranged hierarchical layout
- **Testing Mode**: Step-by-step simulation with state tracking
- **Validation**:
  - Circular dependency detection
  - Reachability analysis (orphan node detection)
  - Solvability checks
- **Hints System**: Add hints per step with configurable cooldowns
- **Rewards**: Configure points, items, or state changes
- **Export**: JSON format compatible with PuzzleSystem

**Technical Details:**
- Layered arrangement algorithm (dependencies determine depth)
- Curved connection arrows with directional indicators
- Color-coded node types for visual clarity
- ~800 lines of JavaScript + HTML + CSS

**Usage:**
```bash
Open editors/puzzle-builder.html
Add steps using template buttons
Connect steps via dependency management
Configure step requirements and hints
Use "Test" to simulate puzzle flow
Validate for circular dependencies and orphans
Export to JSON for game integration
```

---

### Dialogue Tree Editor (`editors/dialogue-editor.html`)

NPC conversation designer with branching dialogue and playthrough mode.

**Node Types:**
1. **Greeting** ğŸ‘‹: Initial NPC greeting
2. **Question** â“: NPC asks player something
3. **Response** ğŸ’¬: NPC responds to player
4. **Branch** ğŸŒ³: Conditional branching point
5. **Trade** ğŸ’°: Trading interface node
6. **End** ğŸ: Conversation termination

**Features:**
- **Branching Conversations**: Multiple response options per node
- **Player Responses**: Add custom player choices with targets
- **Conditional Logic**:
  - Item requirements (has_item)
  - Flag checks (flag_set)
  - Relationship levels (relationship >= value)
- **Emotion System**: 6 emotions affect NPC behavior
  - Neutral, Happy, Sad, Angry, Surprised, Fearful
- **Live Preview**: See dialogue and responses in real-time
- **Playthrough Mode**: Interactive simulation with player choices
- **Validation**: Orphan detection, dead-end warnings
- **Export**: NPCSystem-compatible JSON format

**Technical Details:**
- Tree-style visualization with parent-child relationships
- Auto-expansion algorithm for clean layout
- Response management with target selection
- ~1000 lines of JavaScript + HTML + CSS

**Usage:**
```bash
Open editors/dialogue-editor.html
Set NPC properties (name, personality, greeting)
Add nodes starting with greeting
Configure NPC text and emotion
Add player response options
Link responses to target nodes
Use "Play" for interactive preview
Validate and export for game use
```

---

## ğŸ—‚ï¸ Asset Library System (`js/AssetLibrary.js`)

Comprehensive asset management with search, tagging, and usage tracking.

**Categories:**
- Graphics: images, sprites, backgrounds
- Audio: music, sound effects
- Data: worlds, puzzles, dialogues, JSON files

**Core Features:**

### Asset Management
- **Add/Update/Delete**: Full CRUD operations with validation
- **Metadata**: Name, type, category, format, author, description, thumbnail
- **Organization**: Multi-category system with automatic indexing
- **Versioning**: Track date added and date modified

### Search & Discovery
- **Keyword Search**: Full-text search across name, description, tags
- **Advanced Filtering**:
  - By category, type, tags (multi-select with AND logic)
  - By author
  - By date range (dateFrom, dateTo)
- **Sorting**: date added, name, usage count, size
- **Result Limiting**: Paginated results with configurable limits

### Tagging System
- **Flexible Tags**: Add multiple tags per asset
- **Tag Cloud**: View all tags with usage counts
- **Tag-based Search**: Find assets by tags (AND logic for multiple tags)
- **Auto-cleanup**: Remove tags with zero assets

### Usage Tracking
- **Count**: Track how many times asset is used
- **Context**: Record where asset is used (world_id, puzzle_id, etc.)
- **Last Used**: Timestamp of most recent usage
- **Analytics**: Most used assets, usage trends

### Maintenance Tools
- **Duplicate Detection**: Find assets with same name/size
- **Cleanup**: Remove unused assets older than N days (configurable)
- **Storage Stats**: Total assets, total size, breakdown by category
- **Export/Import**: Backup and restore entire library

**API Examples:**

```javascript
import { AssetLibrary } from './AssetLibrary.js';

const library = new AssetLibrary();

// Add asset
const assetId = library.addAsset({
  name: 'Castle Sprite',
  type: 'sprite',
  category: 'graphics',
  data: spriteData,
  tags: ['medieval', 'building', 'outdoor'],
  author: 'GameDev',
  description: 'Medieval castle sprite for adventure scenes'
});

// Search
const results = library.search({
  query: 'castle',
  category: 'graphics',
  tags: ['medieval'],
  sortBy: 'usage',
  sortOrder: 'desc',
  limit: 10
});

// Track usage
library.trackUsage(assetId, 'world_medieval_001');

// Get statistics
const stats = library.getStatistics();
console.log(`Total assets: ${stats.totalAssets}`);
console.log(`Most used: ${stats.mostUsed.map(a => a.name).join(', ')}`);

// Find duplicates
const duplicates = library.findDuplicates();

// Clean unused assets older than 30 days
const deleted = library.cleanUnusedAssets(30);

// Export/Import
const backup = library.exportLibrary();
localStorage.setItem('asset_backup', JSON.stringify(backup));

library.importLibrary(JSON.parse(localStorage.getItem('asset_backup')));
```

**Technical Details:**
- ~700 lines of code
- Map-based data structures for O(1) lookups
- Search indexing for fast keyword queries
- Graph algorithms for duplicate detection
- LocalStorage persistence
- Statistics calculation with caching

---

## ğŸ¤– Enhanced AI Systems

### Enhanced World Generator (`js/EnhancedWorldGenerator.js`)

Multi-phase AI world generation with quality controls and validation.

**Generation Pipeline:**

1. **Phase 1 - Structure** (30-60s):
   - Generate overall world theme and structure
   - Determine room count, difficulty, genre
   - Create world metadata and setting

2. **Phase 2 - Rooms** (60-120s):
   - Generate individual room descriptions
   - Create exits and connections
   - Define graphics primitives
   - Assign ambient sounds

3. **Phase 3 - NPCs** (30-60s):
   - Create NPC characters with personalities
   - Generate dialogue trees
   - Define trading rules and relationships

4. **Phase 4 - Items** (30-60s):
   - Generate interactive objects
   - Create takeable items
   - Define item combinations and uses

5. **Phase 5 - Puzzles** (60-90s):
   - Design multi-step puzzles
   - Ensure solvability
   - Create hints and rewards
   - Link to required items/objects

**Quality Controls:**
- **Validation After Each Phase**: Automatic error detection
- **Retry Logic**: Up to 3 attempts per phase
- **Auto-Fix**: Common issues repaired automatically
  - Missing connections added
  - Broken references removed
  - Duplicate IDs resolved
- **Template-Based**: Genre-specific templates for consistency
  - Fantasy: castles, forests, dungeons
  - Sci-Fi: space stations, alien worlds
  - Mystery: mansions, crime scenes
  - Horror: haunted houses, dark forests

**Configuration:**
```javascript
const config = {
  genre: 'fantasy',        // fantasy, sci-fi, mystery, horror
  difficulty: 'normal',    // easy, normal, hard
  roomCount: 8,            // 3-20 rooms
  npcCount: 3,             // 0-10 NPCs
  puzzleCount: 4,          // 1-15 puzzles
  maxRetries: 3,           // Retry attempts per phase
  validateEachPhase: true  // Run validation after each phase
};

const world = await generator.generateWorld(config);
```

**Technical Details:**
- ~500 lines of code
- Promise-based async generation
- Error recovery with exponential backoff
- Automatic validation integration
- Generation statistics tracking

---

### World Validator (`js/WorldValidator.js`)

Comprehensive validation for world data consistency and playability.

**Validation Categories:**

1. **Room Validation**:
   - Required properties (id, name, description, exits)
   - Exit destinations exist and are valid
   - Bidirectional exit consistency
   - Graphics definitions present
   - Ambient sound settings

2. **Item Validation**:
   - Unique IDs across all items
   - Required properties (id, name, description)
   - Takeable flag consistency
   - Valid location references (room IDs)
   - Size/weight for inventory items

3. **Object Validation**:
   - Interactive object definitions
   - Valid state machines
   - Action handlers defined
   - Proper use requirements

4. **NPC Validation**:
   - Dialogue tree structure
   - Trading rules validity
   - Schedule and location consistency
   - Relationship bounds (-100 to 100)

5. **Puzzle Validation**:
   - Solvability checks
   - Required items exist
   - Step dependencies valid
   - No circular dependencies
   - Hints provided

6. **Graph Analysis**:
   - **Connectivity**: DFS to verify all rooms reachable
   - **Accessibility**: Check all required items obtainable
   - **Dead Ends**: Warn about one-way paths
   - **Disconnected Components**: Report isolated room groups

**Error Severity Levels:**
- **Error**: Critical issues preventing gameplay
- **Warning**: Non-critical but recommended fixes

**Example Output:**
```javascript
const result = validator.validate(worldData);

if (result.valid) {
  console.log('âœ“ World is valid!');
} else {
  console.log('âœ— Validation failed:');
  result.errors.forEach(error => {
    console.error(`  - ${error.type}: ${error.message}`);
  });
}

if (result.warnings.length > 0) {
  console.log('âš  Warnings:');
  result.warnings.forEach(warning => {
    console.warn(`  - ${warning.type}: ${warning.message}`);
  });
}
```

**Technical Details:**
- ~550 lines of code
- Graph algorithms (DFS, cycle detection)
- Comprehensive error reporting
- Integration with EnhancedWorldGenerator
- Used by World Editor for real-time feedback

---

## ğŸ† Expanded Achievements System (`js/ExpandedAchievements.js`)

50+ achievements across 8 categories with progression tracking.

**Achievement Categories:**

### 1. Story Achievements (8 achievements)
- First Steps, True Ending, Speed Runner, Completionist, etc.
- Track main storyline progress

### 2. Combat Achievements (7 achievements)
- First Blood, Pacifist, Warrior, Berserker, etc.
- Combat-related milestones

### 3. Magic Achievements (6 achievements)
- Novice Mage, Spell Master, Arcane Knowledge, etc.
- Magic usage tracking

### 4. Exploration Achievements (8 achievements)
- Curious Explorer, Cartographer, World Traveler, etc.
- Room and location discovery

### 5. Puzzle Achievements (7 achievements)
- Brain Teaser, Master Detective, No Hints Needed, etc.
- Puzzle-solving prowess

### 6. Social Achievements (6 achievements)
- Diplomat, Merchant, Best Friends, etc.
- NPC interaction and relationships

### 7. Competitive Achievements (4 achievements)
- Speed Runner, Perfect Score, Death Defying, etc.
- Skill-based challenges

### 8. Miscellaneous Achievements (4+ achievements)
- Hoarder, Fashionista, Night Owl, etc.
- Fun and quirky goals

**Rarity Tiers:**
- **Common** ğŸ¥‰: Easy to obtain (50 XP reward)
- **Rare** ğŸ¥ˆ: Moderate challenge (150 XP reward)
- **Epic** ğŸ¥‡: Significant accomplishment (300 XP reward)
- **Legendary** ğŸ’: Extremely difficult (500 XP reward)

**Features:**
- **Incremental Progress**: Track multi-step achievements
  - Current: 25/50 enemies defeated
  - Progress bar in UI
- **Hidden Achievements**: Surprise discoveries
- **Automatic Checking**: Event-driven updates
- **Notifications**: Achievement unlocked popups
- **Statistics Tracking**:
  - Unlocked count by rarity
  - Total XP earned
  - Completion percentage

**Example Achievements:**

```javascript
{
  id: 'legend',
  name: 'Living Legend',
  description: 'Complete 50 adventures',
  category: 'story',
  rarity: 'legendary',
  hidden: false,
  incremental: true,
  progress: { current: 0, target: 50 },
  xpReward: 500
}

{
  id: 'pacifist',
  name: 'Peace Maker',
  description: 'Complete adventure without killing anyone',
  category: 'combat',
  rarity: 'rare',
  hidden: false,
  incremental: false,
  xpReward: 150
}
```

**Technical Details:**
- ~650 lines of code
- Event-driven checking (combat, puzzle, movement events)
- Progress persistence across sessions
- Notification system integration
- XP rewards based on rarity

---

## ğŸ¤ Social Features

### Friend System (`js/FriendSystem.js`)

Real-time friend management and messaging with WebSocket support.

**Features:**

1. **Friend Management**:
   - Send friend requests
   - Accept/reject requests
   - View friends list
   - Remove friends
   - Block/unblock users

2. **Real-Time Messaging**:
   - Direct messages to friends
   - WebSocket-based delivery
   - Typing indicators (3-second expire)
   - Read receipts
   - Message history persistence

3. **Online Status**:
   - Real-time status updates (online/offline)
   - Last seen timestamps
   - Activity indicators

4. **Notifications**:
   - Friend request notifications
   - New message alerts
   - Friend online notifications
   - Unread message counts

**WebSocket Protocol:**
```javascript
// Client â†’ Server
{
  type: 'message',
  to: 'friend_user_id',
  message: {
    id: 'msg_123',
    content: 'Hello!',
    timestamp: 1700000000000
  }
}

// Server â†’ Client
{
  type: 'message',
  from: 'friend_user_id',
  message: {
    id: 'msg_123',
    content: 'Hello!',
    timestamp: 1700000000000,
    read: false
  }
}

// Typing indicator
{
  type: 'typing',
  from: 'friend_user_id'
}

// Status update
{
  type: 'status',
  userId: 'friend_user_id',
  status: 'online'
}
```

**API Integration:**
```javascript
// Send friend request
await friendSystem.sendFriendRequest('target_user_id');

// Accept request
await friendSystem.acceptFriendRequest('request_id');

// Send message
await friendSystem.sendMessage('friend_id', 'Hello!');

// Get conversation
const messages = friendSystem.getConversation('friend_id');

// Track status
const isOnline = friendSystem.isFriendOnline('friend_id');
```

**Technical Details:**
- ~650 lines of code
- WebSocket auto-reconnection
- Message queue for offline delivery
- Conversation threading
- Statistics tracking (messages sent, friends added)

---

## ğŸ“¦ Production-Quality Assets

### Real PNG Icon Generation

Professional PWA icons using Sharp library for image processing.

**Generated Icons:**
- icon-72x72.png through icon-512x512.png (8 sizes)
- apple-touch-icon.png (180x180)
- favicon-16x16.png, favicon-32x32.png
- source-icon-512x512.png (base artwork)

**Source Icon Design:**
- EGA-styled retro aesthetic
- Blue background (#0000AA)
- Yellow "S" letter design (#FFFF55)
- "SOMNIUM" text at bottom
- Decorative stars and crescent moon
- Light cyan border frame

**Generation Process:**
```bash
# Create source icon (512x512)
node scripts/create-source-icon.js

# Generate all sizes from source
node scripts/generate-icons.js

# Output: 12 PNG files in assets/icons/
```

**Technical Details:**
- Sharp library for high-quality resizing
- Lanczos3 kernel for crisp downsampling
- PNG compression level 9 for size optimization
- SVG-to-PNG conversion
- Automatic manifest.json updates

---

## ğŸ› ï¸ Integration Points

### World Editor â†’ Game Engine
```javascript
// Export world from editor
const worldJSON = worldEditor.exportWorld();

// Load in game engine
await gameManager.loadWorld(worldJSON);
```

### Puzzle Builder â†’ PuzzleSystem
```javascript
// Export puzzle from builder
const puzzleJSON = puzzleBuilder.exportPuzzle();

// Add to game
gameManager.puzzleSystem.addPuzzle(puzzleJSON);
```

### Dialogue Editor â†’ NPCSystem
```javascript
// Export dialogue tree
const dialogueJSON = dialogueEditor.exportDialogue();

// Assign to NPC
npc.dialogueTree = dialogueJSON.dialogueTree;
```

### Asset Library â†’ All Systems
```javascript
// Load asset from library
const sprite = assetLibrary.getAsset('sprite_castle_001');

// Track usage
assetLibrary.trackUsage('sprite_castle_001', 'world_medieval_001');

// Update statistics
const stats = assetLibrary.getStatistics();
```

---

## ğŸ“Š Statistics & Metrics

### Code Additions (v2.1.0)
- **11,000+ lines** of new code
- **4 major backend modules** (FriendSystem, EnhancedWorldGenerator, WorldValidator, ExpandedAchievements)
- **3 complete visual editors** with HTML/CSS/JS (~5,000 lines total)
- **1 asset management system** (~700 lines)
- **2 icon generation scripts** (~200 lines)
- **12 production PNG icons** generated

### File Structure
```
Somnium/
â”œâ”€â”€ editors/                    # NEW
â”‚   â”œâ”€â”€ world-editor.html
â”‚   â”œâ”€â”€ puzzle-builder.html
â”‚   â””â”€â”€ dialogue-editor.html
â”œâ”€â”€ css/                        # ENHANCED
â”‚   â”œâ”€â”€ world-editor.css
â”‚   â”œâ”€â”€ puzzle-builder.css
â”‚   â””â”€â”€ dialogue-editor.css
â”œâ”€â”€ js/                         # NEW MODULES
â”‚   â”œâ”€â”€ AssetLibrary.js         # ~700 lines
â”‚   â”œâ”€â”€ FriendSystem.js         # ~650 lines
â”‚   â”œâ”€â”€ EnhancedWorldGenerator.js  # ~500 lines
â”‚   â”œâ”€â”€ WorldValidator.js       # ~550 lines
â”‚   â”œâ”€â”€ ExpandedAchievements.js # ~650 lines
â”‚   â””â”€â”€ editors/
â”‚       â”œâ”€â”€ WorldEditor.js      # ~1000 lines
â”‚       â”œâ”€â”€ PuzzleBuilder.js    # ~800 lines
â”‚       â””â”€â”€ DialogueEditor.js   # ~1000 lines
â”œâ”€â”€ scripts/                    # NEW
â”‚   â”œâ”€â”€ create-source-icon.js
â”‚   â””â”€â”€ generate-icons.js
â””â”€â”€ assets/icons/               # NEW
    â”œâ”€â”€ source-icon-512x512.png
    â”œâ”€â”€ icon-*.png (8 sizes)
    â”œâ”€â”€ apple-touch-icon.png
    â””â”€â”€ favicon-*.png (2 sizes)
```

---

## ğŸš€ What's Next (v2.2 and Beyond)

### Medium Priority
- **Test Coverage to 80%+**: Write comprehensive tests for new modules
- **JSDoc Documentation**: Complete API documentation for all modules
- **Performance Optimization**: Profiling and memory optimization

### Future Enhancements
- **Mobile/Responsive UI**: Touch-friendly editor interfaces
- **Collaborative Editing**: Real-time multi-user world editing
- **Cloud Asset Storage**: Store assets in cloud
- **Marketplace**: Share and sell custom worlds/assets
- **Advanced AI**: GPT-4 Vision for image-based world generation
- **VR/AR Support**: 3D rendering of vector worlds
- **Voice Commands**: Speech-to-text parser input
- **Leaderboards**: Competitive speedrun tracking
- **Tournaments**: Organized competitive events

---

## ğŸ“š Documentation

- [Editors Guide](editors-guide.md) - Complete guide to using visual tools
- [Asset Library API](../js/AssetLibrary.js) - JSDoc inline documentation
- [World Validation](../js/WorldValidator.js) - Validation rules reference
- [Achievement System](../js/ExpandedAchievements.js) - All 50+ achievements

---

## ğŸ”„ Upgrade Path from v2.0

All v2.1 features are **fully backward compatible** with v2.0:

1. Pull latest code from repository
2. Install new dependencies: `npm install` (for Sharp library)
3. Run icon generation: `npm run generate-icons` (optional)
4. All existing save files and worlds work without modification
5. New editors available at `editors/*.html`
6. New modules auto-loaded by GameManager

**No breaking changes. All v2.0 features preserved.**

---

*Version 2.1.0 transforms Somnium from a game into a complete game creation platform. Build, share, and play unlimited adventures!* ğŸ®âœ¨
