# Somnium v2.0 - Feature Documentation

## Overview

Somnium v2.0 is a major upgrade that transforms the engine from a standalone adventure game into a comprehensive platform for creating, sharing, and playing AI-driven adventures with multiplayer capabilities, advanced graphics effects, and extensive mod support.

## New Features

### 1. Progressive Web App (PWA) Support

Somnium is now a fully-featured Progressive Web App that can be installed on any device.

**Key Features:**
- **Offline Play**: Complete game functionality without internet connection
- **Install to Device**: Add Somnium to home screen on mobile/desktop
- **Auto-Updates**: Automatic background updates with user notification
- **File Handling**: Open `.somnium` save files directly from file manager
- **Protocol Handler**: Custom `web+somnium://` protocol for sharing worlds

**Files:**
- `manifest.json` - PWA configuration
- `service-worker.js` - Offline caching and background sync
- Updated `index.html` with PWA meta tags

**Usage:**
```javascript
// The service worker is automatically registered
// Users can install via browser prompt or "Add to Home Screen"
```

---

### 2. Plugin/Mod System

Extensible architecture allowing developers to create custom functionality.

**Key Features:**
- **Sandboxed Execution**: Safe plugin environment
- **Event-Based Hooks**: 15+ lifecycle hooks
- **Custom Commands**: Register new parser verbs
- **Hot Reloading**: Update plugins without restart
- **Plugin Storage**: Scoped localStorage for each plugin
- **Network Access Control**: Permission-based API access

**Files:**
- `js/PluginManager.js`

**API Example:**
```javascript
// Creating a plugin
export default class MyPlugin {
  constructor(api) {
    this.api = api;
  }

  async onInit() {
    // Called when plugin loads
    this.api.registerCommand('custom', this.handleCustomCommand.bind(this));

    this.api.on('onRoomEnter', (room) => {
      this.api.addOutputText(`You entered: ${room.name}`, 'system');
    });
  }

  handleCustomCommand(command) {
    this.api.addOutputText('Custom command executed!', 'action');
  }
}
```

**Plugin Manifest:**
```json
{
  "id": "my-plugin",
  "name": "My Awesome Plugin",
  "version": "1.0.0",
  "author": "Your Name",
  "entry": "./plugins/my-plugin.js",
  "permissions": ["network"],
  "dependencies": []
}
```

**Loading Plugins:**
```javascript
const pluginManager = new PluginManager(gameManager);

await pluginManager.registerPlugin(manifest);
await pluginManager.loadPlugin('my-plugin');
```

---

### 3. WebGL Renderer with Shader Effects

Advanced graphics rendering with retro-inspired shader effects.

**Key Features:**
- **CRT Effect**: Authentic cathode ray tube simulation with curvature and scanlines
- **Bloom**: Glow effects for bright elements
- **Pixelation**: Retro pixel aesthetic
- **Chromatic Aberration**: Color separation effect
- **Vignette**: Screen edge darkening
- **Multi-Pass Rendering**: Composited effects pipeline

**Files:**
- `js/WebGLRenderer.js`

**Usage:**
```javascript
const webglRenderer = new WebGLRenderer(displayCanvas);
await webglRenderer.initialize();

// Enable/disable effects
webglRenderer.toggleEffect('crtEffect', true);
webglRenderer.toggleEffect('scanlines', true);
webglRenderer.toggleEffect('bloom', false);

// Adjust parameters
webglRenderer.setParam('crtCurvature', 0.15);
webglRenderer.setParam('scanlineIntensity', 0.3);

// Render 2D canvas with effects
webglRenderer.render(game2DCanvas, time);
```

**Shader Effects:**
- **CRT**: `crtCurvature`, `scanlineIntensity`
- **Bloom**: `bloomThreshold`, `bloomIntensity`
- **Pixelate**: `pixelSize`
- **Vignette**: `vignetteIntensity`
- **Aberration**: `aberrationAmount`

---

### 4. Cloud Save Synchronization

Multi-device save game sync with conflict resolution.

**Key Features:**
- **Multi-Backend Support**: Firebase, custom API, or localStorage
- **Auto-Sync**: Configurable sync intervals
- **Conflict Resolution**: Multiple strategies (newest, local, remote, manual)
- **Background Sync**: Service Worker integration
- **Save Encryption**: Optional cloud save encryption

**Files:**
- `js/CloudSaveManager.js`

**Usage:**
```javascript
const cloudSaveManager = new CloudSaveManager(saveGameManager, {
  backend: 'api',
  apiEndpoint: 'https://api.example.com/saves',
  autoSync: true,
  syncInterval: 300000, // 5 minutes
  conflictResolution: 'newest',
});

await cloudSaveManager.initialize();

// Authenticate
await cloudSaveManager.authenticate('email', {
  email: 'user@example.com',
  password: 'password',
});

// Manual sync
const result = await cloudSaveManager.sync();
console.log(`Synced: ${result.uploaded} up, ${result.downloaded} down`);

// Listen for conflicts
cloudSaveManager.on('conflicts-detected', (conflicts) => {
  // Show UI for manual resolution
});
```

---

### 5. Real-Time Multiplayer

WebSocket-based multiplayer with co-op and competitive modes.

**Key Features:**
- **Session Management**: Create/join game sessions
- **Multiple Modes**: Co-op, competitive, shared world
- **Player Actions**: Synchronized movement, interactions, chat
- **State Synchronization**: Real-time game state merging
- **Reconnection**: Automatic reconnection with exponential backoff
- **Heartbeat**: Keep-alive mechanism

**Files:**
- `js/MultiplayerManager.js`

**Usage:**
```javascript
const multiplayerManager = new MultiplayerManager(gameManager, {
  serverUrl: 'ws://localhost:8080',
  reconnectAttempts: 5,
  reconnectDelay: 3000,
});

// Connect to server
await multiplayerManager.connect('PlayerName');

// Create session
const session = await multiplayerManager.createSession({
  maxPlayers: 4,
  mode: 'coop',
  worldId: 'fantasy-quest',
  private: false,
});

// Or join existing session
await multiplayerManager.joinSession('session-id');

// Send player action
multiplayerManager.sendAction({
  type: 'move',
  data: { room: 'castle' },
});

// Send chat message
multiplayerManager.sendChat('Hello everyone!');

// Listen for events
multiplayerManager.on('player_joined', (player) => {
  console.log(`${player.name} joined!`);
});

multiplayerManager.on('player_action', ({ playerId, action }) => {
  // Handle other player's action
});
```

---

### 6. Visual World Editor

Comprehensive drag-and-drop world editor with real-time preview.

**Key Features:**
- **Visual Room Editing**: Draw primitives directly on canvas
- **Property Panels**: Edit object/NPC/item properties
- **Room Connections**: Visual exit management
- **Graphics Tools**: Rectangle, circle, polygon, line tools
- **EGA Color Picker**: Full 16-color palette
- **Undo/Redo**: 50-level history
- **Import/Export**: JSON world files
- **Test Mode**: Launch game directly from editor

**Files:**
- `editor.html`
- `css/editor.css`
- `js/WorldEditor.js`

**Features:**
- **Palette Tabs**: Rooms, Objects, Items, NPCs
- **Drawing Tools**: Select, Rectangle, Circle, Polygon, Line
- **Properties Panel**: Edit selected primitive properties
- **World Settings**: Metadata, genre, author
- **Keyboard Shortcuts**: Ctrl+S (save), Ctrl+Z (undo), Ctrl+Y (redo)

**Opening the Editor:**
```
http://localhost:8080/editor.html
```

---

### 7. Advanced Web Audio Features

Professional audio processing using Web Audio API.

**Key Features:**
- **Spatial Audio**: 3D positional audio with HRTF
- **Convolution Reverb**: 4 impulse responses (room, hall, cave, church)
- **Real-Time Analysis**: Waveform and frequency data
- **Dynamic Compression**: Master bus compressor
- **Multi-Band EQ**: 3-band parametric equalizer
- **Vocoder**: 16-band vocoder effect
- **Audio Ducking**: Automatic volume reduction
- **Visualization**: Real-time waveform canvas

**Files:**
- `js/AdvancedAudioManager.js`

**Usage:**
```javascript
const advancedAudio = new AdvancedAudioManager(soundManager);
await advancedAudio.initialize();

// Create spatial audio source
advancedAudio.createSpatialSource('footsteps', { x: 10, y: 0, z: 5 });
advancedAudio.updateSpatialSourcePosition('footsteps', { x: 15, y: 0, z: 3 });

// Update listener (player) position
advancedAudio.updateListenerPosition({ x: 0, y: 0, z: 0 });

// Apply reverb
const reverbEffect = advancedAudio.applyReverb('cave', audioSource);

// Get analysis data
const analysis = advancedAudio.getAnalysisData();
console.log('RMS:', analysis.rms, 'Peak:', analysis.peak);

// Create visualization
advancedAudio.createVisualization(canvasElement);
```

---

### 8. Social Sharing Features

Share saves, worlds, achievements, and screenshots with the community.

**Key Features:**
- **Save Sharing**: Upload and share save games
- **World Sharing**: Publish custom worlds
- **Achievement Sharing**: Share unlocked achievements
- **Screenshots**: Capture and share gameplay moments
- **Social Media Integration**: Twitter, Facebook, Reddit, Discord
- **Community Browser**: Discover shared content
- **Rating System**: Rate and review shared content
- **Embed Codes**: Embed shared content on websites

**Files:**
- `js/SocialManager.js`

**Usage:**
```javascript
const socialManager = new SocialManager(gameManager);

// Share save game
await socialManager.shareSaveGame(1, {
  title: 'My Epic Adventure',
  description: 'Just defeated the dragon!',
  public: true,
});

// Share custom world
await socialManager.shareWorld(worldData, {
  title: 'My Custom World',
  description: 'A challenging puzzle adventure',
  tags: ['puzzle', 'hard'],
});

// Share achievement
await socialManager.shareAchievement('dragon_slayer');

// Share screenshot
await socialManager.shareScreenshot(gameCanvas, {
  title: 'Epic Boss Battle',
  description: 'Final confrontation with Malakor',
});

// Browse shared worlds
const result = await socialManager.browseSharedWorlds({
  genre: 'fantasy',
  sort: 'popular',
  page: 1,
});

// Load shared content
const shared = await socialManager.loadSharedContent('share-id');
```

---

## Integration Guide

### Adding v2.0 Features to Existing Projects

**1. PWA Support:**
```html
<!-- Add to index.html <head> -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0000AA">

<!-- Add before </body> -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js');
  }
</script>
```

**2. Initialize v2.0 Managers:**
```javascript
// In main.js or game initialization
import { PluginManager } from './js/PluginManager.js';
import { WebGLRenderer } from './js/WebGLRenderer.js';
import { CloudSaveManager } from './js/CloudSaveManager.js';
import { MultiplayerManager } from './js/MultiplayerManager.js';
import { AdvancedAudioManager } from './js/AdvancedAudioManager.js';
import { SocialManager } from './js/SocialManager.js';

// Initialize managers
const pluginManager = new PluginManager(gameManager);
const webglRenderer = new WebGLRenderer(displayCanvas);
const cloudSaveManager = new CloudSaveManager(saveGameManager);
const multiplayerManager = new MultiplayerManager(gameManager);
const advancedAudio = new AdvancedAudioManager(soundManager);
const socialManager = new SocialManager(gameManager);

// Initialize asynchronously
await Promise.all([
  pluginManager.initialize(),
  webglRenderer.initialize(),
  cloudSaveManager.initialize(),
  advancedAudio.initialize(),
]);
```

**3. Update Game Loop:**
```javascript
function render() {
  // Render to 2D canvas as usual
  sceneRenderer.render(ctx);

  // Apply WebGL effects
  if (webglRenderer.initialized) {
    webglRenderer.render(canvas2D, performance.now());
  }
}
```

---

## Configuration

### Environment Variables

Create `js/config.js`:
```javascript
export const API_CONFIG = {
  // Cloud saves
  cloudSaveEndpoint: 'https://api.example.com/saves',

  // Multiplayer
  multiplayerServer: 'wss://multiplayer.example.com',

  // Social sharing
  shareEndpoint: 'https://api.example.com/share',

  // LLM (existing)
  provider: 'openai',
  apiKey: 'your-api-key',
  model: 'gpt-4',
};
```

### Feature Flags

```javascript
const FEATURES = {
  pwa: true,
  plugins: true,
  webgl: true,
  cloudSaves: true,
  multiplayer: false, // Requires server
  socialSharing: true,
  advancedAudio: true,
};
```

---

## Performance Considerations

**WebGL Renderer:**
- Effects run at 60 FPS on modern hardware
- Disable effects on low-end devices
- Uses GPU acceleration for all shader operations

**Cloud Sync:**
- Default sync interval: 5 minutes
- Compresses save data before upload
- Uses IndexedDB for offline queue

**Multiplayer:**
- WebSocket keepalive every 30 seconds
- Automatic reconnection with exponential backoff
- Client-side prediction for smooth movement

**Service Worker:**
- Caches essential files (2-3 MB)
- Runtime cache limited to 50 MB
- Automatic cleanup of old caches

---

## Browser Compatibility

- **Chrome/Edge**: Full support (recommended)
- **Firefox**: Full support
- **Safari**: PWA limited, WebGL supported
- **Mobile**: iOS 13+, Android 5+

**Required APIs:**
- ES6 Modules
- Web Audio API
- WebGL/WebGL2
- IndexedDB
- Service Workers (optional, for PWA)
- WebSockets (optional, for multiplayer)

---

## Migration from v1.0

### Breaking Changes

**None!** v2.0 is fully backward compatible. All v1.0 saves and worlds work without modification.

### New Dependencies

- No new external dependencies
- All features use native Web APIs

### Opt-In Features

All v2.0 features are opt-in:
- PWA works automatically if service-worker.js is present
- Other features require explicit initialization
- Games can use only the features they need

---

## Examples

See:
- `demos/demo-webgl.html` - WebGL effects showcase
- `demos/demo-multiplayer.html` - Multiplayer example
- `demos/demo-plugins.html` - Plugin system demo
- `editor.html` - Full world editor

---

## Support

- **Documentation**: `/docs/`
- **Issues**: https://github.com/doublegate/Somnium/issues
- **Discord**: (community server URL)
- **Email**: support@somnium.game

---

## License

MIT License - See LICENSE file for details
